<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>예비수강신청</title>
  <link rel="stylesheet" href="../common/style.css">
  <link rel="stylesheet" href="/css/basket.css">
</head>
<body>
  <!-- 탭 + 빠른신청 -->
  <!-- 대기열 모달 (메시지 스타일) -->
  <div id="queue-modal" style="display:none;">
    <div>
      <div class="title" id="queue-title">신청 대기</div>
      <div class="message" id="queue-message">잠시만 기다려주세요... (0초)</div>
    </div>
  </div>
  <div class="tabs-container">
    <ul class="sw-tabs">
      <li data-tab="tab-1" class="is-active">개설과목</li>
      <li data-tab="tab-2">예비수강내역</li>
      <li data-tab="tab-3">수강신청내역</li>
    </ul>
    <div class="quick-request">
      <label>빠른신청</label>
      <span style="color: #666;">과목코드.분반 :</span>
      <input type="text" id="quick-code" class="code-input" placeholder="" />
      <span class="separator">-</span>
      <input type="text" id="quick-class" class="class-input" placeholder="001" />
      <button onclick="quickAddToBasket()">예비신청</button>
    </div>
  </div>

  <div class="sw-tab-contents">
    <!-- 탭 1: 개설과목 + 예비수강 내역 -->
    <div id="tab-1" class="is-active">
      <!-- 라디오 그룹 -->
      <div style="padding:8px 0;">
        <div class="radio-group" id="idSearchType" style="display: inline-flex; gap:8px;">
          <input type="radio" name="pSearchType" id="pSearchType1" value="1" checked=""><label for="pSearchType1" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">전공 / 학과</label>
          <input type="radio" name="pSearchType" id="pSearchType2" value="2"><label for="pSearchType2" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">이수구분</label>
          <input type="radio" name="pSearchType" id="pSearchType3" value="3"><label for="pSearchType3" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">다전공</label>
          <input type="radio" name="pSearchType" id="pSearchType0" value="0"><label for="pSearchType0" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">과목검색</label>
        </div>
      </div>

      <!-- 검색 폼 -->
      <div class="form-search" id="idSearchDiv">
        <!-- 1: 학부 / 학과 -->
        <div id="idMajor" style="display: block;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThSust1">학부</th>
                <td id="idTdSust1">
                  <select name="pSustCd1" id="pSustCd1"></select>
                </td>
                <th id="idThMajor1">학과</th>
                <td id="idTdMajor1">
                  <select name="pMajorCd1" id="pMajorCd1"><option value="">전체학과</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm1" id="pLectNm1" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch1" onclick="filterCourses('1')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 2: 이수구분 -->
        <div id="idIsu" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>이수구분</th>
                <td>
                  <select name="pIsuCd2" id="pIsuCd2"><option value="전공필수">전공필수</option><option value="전공선택">전공선택</option><option value="전공기초">전공기초</option><option value="교양필수">교양필수</option><option value="교양선택">교양선택</option><option value="채플">채플</option><option value="연계필수">연계필수</option><option value="연계선택">연계선택</option></select>
                </td>
                <th id="idThSelect2" style="display: none;">교양선택</th>
                <td id="idTdSelect2" style="display: none;">
                  <select name="pSelectCd2" id="pSelectCd2"><option value="CMF024001">핵심</option><option value="CMF024002">자유</option></select>
                </td>
                <th id="idThDown2" style="display: none;">하위영역</th>
                <td id="idTdDown2" style="display: none;">
                  <select name="pDownCd2" id="pDownCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThSust2">학부</th>
                <td id="idTdSust2">
                  <select name="pSustCd2" id="pSustCd2"></select>
                </td>
                <th id="idThMajor2">학과</th>
                <td id="idTdMajor2">
                  <select name="pMajorCd2" id="pMajorCd2"><option value="">전체학과</option></select>
                </td>
                <th id="idThArea2" style="display: none;">영역</th>
                <td id="idTdArea2" style="display: none;">
                  <select name="pAreaCd2" id="pAreaCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option><option value="CMF004033">융복합</option><option value="">전체</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm2" id="pLectNm2" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch2" onclick="filterCourses('2')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 3: 다전공 -->
        <div id="idMultiple" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="220px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThMultiple3">다전공</th>
                <td id="idTdMultiple3">
                  <select name="pMultiCd3" id="pMultiCd3"></select>
                </td>
                <th id="idThSust3">학부</th>
                <td id="idTdSust3">
                  <select name="pSustCd3" id="pSustCd3"></select>
                </td>
                <th id="idThMajor3">학과</th>
                <td id="idTdMajor3">
                  <select name="pMajorCd3" id="pMajorCd3"><option value="">전체학과</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThComposite3" style="display: none;">융복합</th>
                <td id="idTdComposite3" style="display: none;">
                  <select name="pComplexCd3" id="pComplexCd3"><option value="">선택안함</option><option value="U0130010000">청소년전공</option><option value="U0130020000">글로벌외국어통상무역전공</option><option value="U0130030000">스포츠헬스케어전공</option><option value="U0130040000">멀티미디어사운드&뮤직</option></select>
                </td>
                <th id="idThMicro3" style="display: none;">마이크로전공</th>
                <td id="idTdMicro3" style="display: none;">
                  <select name="pMicroCd3" id="pMicroCd3"><option value="">선택안함</option><option value="CMI012001">디지털마케팅전문가과정</option><option value="CMI012002">창의융합예술교육전문학위과정</option><option value="CMI012003">HSK교육전문가과정</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm3" id="pLectNm3" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch3" onclick="filterCourses('3')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 4: 과목검색 -->
        <div id="idSearch" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="280px">
              <col width="10px">
              <col width="120px">
              <col width="10px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>조회</th>
                <td>
                  <input name="pLectNm0" id="pLectNm0" style="width: 250px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch0" onclick="filterCourses('0')">조회</button></td>
                <th></th>
                <td>
                  <p style="font-size: 11px; color: #1976d2; margin: 0;"><b>검색명을 입력하고 엔터를 누르거나 조회 버튼을 눌러 조회하세요</b></p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 개설과목 결과 -->
      <div class="sw-header">
        <div>
          <h1>개설과목 조회<small> &gt; <span id="search-title">계절학기</span></small></h1>
        </div>
        <div class="actions">
          <div class="info-group">
            <label>Total :</label>
            <span class="txt-red"><em id="total-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="height: 96px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">담기</th>
            </tr>
          </thead>
          <tbody id="course-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">조회버튼을 클릭하여 개설교과목을 조회하세요.</td></tr>
          </tbody>
        </table>
      </div>
      

      <!-- 예비수강 내역 -->
      <div class="sw-header">
        <h1>예비수강 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="basket-credit">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="basket-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="basket-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">예비수강이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 3px; margin-bottom: 15px;">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>

    <!-- 탭 2: 예비수강내역 -->
    <div id="tab-2">
      <div class="sw-header">
        <h1>예비수강 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit-basket">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count-basket">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="register-table-basket">
            <tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="form-search">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>

    <!-- 탭 3: 수강신청내역 -->
    <div id="tab-3">
      <div class="sw-header">
        <h1>수강신청 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit-tab3">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count-tab3">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="register-table-tab3">
            <tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 3px; margin-bottom: 15px;">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="../js/data_from_real.js"></script>
  <script src="../js/queue.js"></script>
  <script>
    let allSubjects = [];
    let currentSearchType = '1';
    
    if (typeof subjects !== 'undefined' && Array.isArray(subjects)) {
      allSubjects = subjects;
      console.log('allSubjects loaded:', allSubjects.length, 'items');
    } else {
      console.error('subjects is not defined or not an array');
    }

    function initRadioFormSwitch() {
      const radios = document.querySelectorAll('input[name="pSearchType"]');
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          currentSearchType = this.value;
          switchSearchForm(this.value);
        });
      });
    }

    function switchSearchForm(searchType) {
      document.getElementById('idMajor').style.display = 'none';
      document.getElementById('idIsu').style.display = 'none';
      document.getElementById('idMultiple').style.display = 'none';
      document.getElementById('idSearch').style.display = 'none';

      console.log('[switchSearchForm] searchType:', searchType);
      switch(searchType) {
        case '1':
          document.getElementById('idMajor').style.display = 'block';
          break;
        case '2':
          document.getElementById('idIsu').style.display = 'block';
          fnComboMajorFilter('2');
          break;
        case '3':
          document.getElementById('idMultiple').style.display = 'block';
          fnComboMajorFilter('3');
          break;
        case '0':
          document.getElementById('idSearch').style.display = 'block';
          break;
      }
    }

    document.querySelectorAll('.sw-tabs li').forEach(li => {
      li.onclick = function() {
        const tabId = this.dataset.tab;
        document.querySelectorAll('.sw-tabs li').forEach(l => l.classList.remove('is-active'));
        document.querySelectorAll('.sw-tab-contents > div').forEach(d => d.classList.remove('is-active'));
        this.classList.add('is-active');
        document.getElementById(tabId).classList.add('is-active');
        
        if (tabId === 'tab-2') renderBasketListInTab2();
        if (tabId === 'tab-3') renderRegisterListInTab3();
      };
    });

    function initDepts1() {
      const select = document.getElementById('pSustCd1');
      if (!select) {
        console.error('[initDepts1] pSustCd1 select이 없음!');
        return;
      }
      
      select.innerHTML = '';
      const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
      
      depts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        select.appendChild(opt);
      });

      console.log('[initDepts1] pSustCd1 옵션 추가됨:', depts.length);

      if (select.options.length > 0) {
        select.value = select.options[0].value;
        console.log('[initDepts1] pSustCd1 초기값 설정:', select.options[0].value);
        
        select.addEventListener('change', function() {
          console.log('[pSustCd1 change event] value:', this.value);
          fnComboMajorFilter('1');
        });
        
        console.log('[initDepts1] fnComboMajorFilter(1) 호출');
        fnComboMajorFilter('1');
      }
    }

    function fnComboMajorFilter(type) {
      console.log('[fnComboMajorFilter] type:', type);
      
      if (type === '1') {
        const deptSelect = document.getElementById('pSustCd1');
        const majorSelect = document.getElementById('pMajorCd1');
        const deptValue = deptSelect?.value;
        
        console.log('[fnComboMajorFilter-1] deptValue:', deptValue);
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        if (deptValue) {
          const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
          console.log('[fnComboMajorFilter-1] majors:', majors);
          majors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
          });
        }
      }
      
      if (type === '2') {
        const deptSelect = document.getElementById('pSustCd2');
        const majorSelect = document.getElementById('pMajorCd2');
        const deptValue = deptSelect?.value;
        
        console.log('[fnComboMajorFilter-2] deptValue:', deptValue);
        
        if (!majorSelect) {
          console.error('[fnComboMajorFilter-2] majorSelect(pMajorCd2)이 없음!');
          return;
        }
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        if (deptValue) {
          const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
          console.log('[fnComboMajorFilter-2] majors:', majors);
          majors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
          });
        }
      }
      
      if (type === '3') {
        const deptSelect = document.getElementById('pSustCd3');
        const majorSelect = document.getElementById('pMajorCd3');
        const deptValue = deptSelect?.value;
        
        console.log('[fnComboMajorFilter-3] deptValue:', deptValue);
        
        if (!majorSelect) {
          console.error('[fnComboMajorFilter-3] majorSelect(pMajorCd3)이 없음!');
          return;
        }
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        if (deptValue) {
          const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
          console.log('[fnComboMajorFilter-3] majors:', majors);
          majors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
          });
        }
      }
    }

    function fnComboIsuFilter(type) {
      console.log('[fnComboIsuFilter] type:', type);
      if (type === '2') {
        const isuSelect = document.getElementById('pIsuCd2');
        const isuValue = isuSelect.value;
        
        const selectRow = document.getElementById('idThSelect2');
        const downRow = document.getElementById('idThDown2');
        
        if (isuValue === '교양선택') {
          selectRow.style.display = '';
          document.getElementById('idTdSelect2').style.display = '';
          downRow.style.display = '';
          document.getElementById('idTdDown2').style.display = '';
        } else {
          selectRow.style.display = 'none';
          document.getElementById('idTdSelect2').style.display = 'none';
          downRow.style.display = 'none';
          document.getElementById('idTdDown2').style.display = 'none';
        }
      }
    }

    function initIsuTypes() {
      const select = document.getElementById('pIsuCd2');
      if (!select) return;
      
      select.innerHTML = '';
      const types = [
        { text: '전공필수' },
        { text: '전공선택' },
        { text: '전공기초' },
        { text: '교양필수' },
        { text: '교양선택' },
        { text: '채플' },
        { text: '연계필수' },
        { text: '연계선택' }
      ];
      
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type.text;
        opt.textContent = type.text;
        select.appendChild(opt);
      });
      
      select.addEventListener('change', function() {
        fnComboIsuFilter('2');
      });

      const sustSelect = document.getElementById('pSustCd2');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          sustSelect.addEventListener('change', function() {
            fnComboMajorFilter('2');
          });
          fnComboMajorFilter('2');
        }
      }

      const majorSelect = document.getElementById('pMajorCd2');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
      }
    }

    function fnChkVal(type) {
      if (type === '3') {
        const multiValue = document.getElementById('pMultiCd3').value;
        const compositeRow = document.getElementById('idThComposite3');
        const microRow = document.getElementById('idThMicro3');

        if (multiValue === 'CMF005008') {
          compositeRow.style.display = '';
          document.getElementById('idTdComposite3').style.display = '';
        } else {
          compositeRow.style.display = 'none';
          document.getElementById('idTdComposite3').style.display = 'none';
        }

        if (multiValue === 'CMF005009') {
          microRow.style.display = '';
          document.getElementById('idTdMicro3').style.display = '';
        } else {
          microRow.style.display = 'none';
          document.getElementById('idTdMicro3').style.display = 'none';
        }
      }
    }

    function initMultipleTypes() {
      const select = document.getElementById('pMultiCd3');
      if (!select) return;
      
      select.innerHTML = '';
      const types = [
        { value: 'CMF005001', text: '부전공' },
        { value: 'CMF005002', text: '복수전공' },
        { value: 'CMF005008', text: '융복합전공' },
        { value: 'CMF005009', text: '마이크로전공' }
      ];
      
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type.value;
        opt.textContent = type.text;
        select.appendChild(opt);
      });

      select.addEventListener('change', function() {
        fnComboMajorFilter('3');
        fnChkVal('3');
      });

      const sustSelect = document.getElementById('pSustCd3');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          sustSelect.addEventListener('change', function() {
            fnComboMajorFilter('3');
          });
          fnComboMajorFilter('3');
        }
      }

      const majorSelect = document.getElementById('pMajorCd3');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
      }
    }

    function filterCourses(searchType = null) {
      if (searchType === null) searchType = currentSearchType;

      let filtered = [];

      if (searchType === '1') {
        const dept = document.getElementById('pSustCd1')?.value || '';
        const major = document.getElementById('pMajorCd1')?.value || '';
        const search = (document.getElementById('pLectNm1')?.value || '').toLowerCase();

        if (dept) {
          filtered = allSubjects.filter(s => {
            if (s.dept !== dept) return false;
            if (major && s.major !== major) return false;
            if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
            return true;
          });
        }
      } else if (searchType === '2') {
        const type = document.getElementById('pIsuCd2')?.value || '';
        const sustValue = document.getElementById('pSustCd2')?.value || '';
        const majorValue = document.getElementById('pMajorCd2')?.value || '';
        const search = (document.getElementById('pLectNm2')?.value || '').toLowerCase();

        filtered = allSubjects.filter(s => {
          if (type && s.type !== type) return false;
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
      } else if (searchType === '3') {
        const sustValue = document.getElementById('pSustCd3')?.value || '';
        const majorValue = document.getElementById('pMajorCd3')?.value || '';
        const search = (document.getElementById('pLectNm3')?.value || '').toLowerCase();

        filtered = allSubjects.filter(s => {
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
      } else if (searchType === '0') {
        const search = (document.getElementById('pLectNm0')?.value || '').toLowerCase();
        filtered = allSubjects.filter(s => {
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
      }

      document.getElementById('total-count').textContent = filtered.length;
      const tbody = document.getElementById('course-table');
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">검색 결과가 없습니다.</td></tr>';
        return;
      }

      filtered.forEach((s, i) => {
        const cap = s.cap !== undefined ? s.cap : 30;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${cap}</td>
          <td><button class="btn-add" onclick="addToBasket('${s.code}', '${s.name}', '${s.dept}', '${s.major}', '${s.year}', '${s.type}', '${s.credit}', '${cap}')">담기</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.addToBasket = function(code, name, dept, major, year, type, credit, cap) {
      if (!dept || !dept.trim() || !major || !major.trim()) {
        alert('유효한 과목이 아닙니다.');
        return;
      }

      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      if (list.find(s => s.code === code)) {
        alert('이미 담은 과목입니다.');
        return;
      }
      
      QueueModal.showApply(function() {
        list.push({ code, name, dept, major, year, type, credit, cap });
        localStorage.setItem('basketList', JSON.stringify(list));
        filterCourses(currentSearchType);
        renderBasketListInTab2();
        alert('예비수강에 추가되었습니다.');
      });
    };

    window.removeFromBasket = function(code) {
      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      list = list.filter(s => s.code !== code);
      localStorage.setItem('basketList', JSON.stringify(list));
      filterCourses(currentSearchType);
      renderBasketListInTab2();
    };

    window.removeFromRegister = function(code) {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      list = list.filter(s => s.code !== code);
      localStorage.setItem('registerList', JSON.stringify(list));
      renderRegisterListInTab3();
    };

    function renderBasketListInTab2() {
      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      const tbody = document.getElementById('register-table-basket');
      if (!tbody) return;
      
      tbody.innerHTML = '';

      if (list.length === 0) {
        document.getElementById('register-credit-basket').textContent = '0';
        document.getElementById('register-count-basket').textContent = '0';
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">예비수강이 없습니다.</td></tr>';
        return;
      }

      let totalCredit = 0;
      list.forEach((s, i) => {
        totalCredit += parseInt(s.credit, 10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${s.cap}</td>
          <td><button class="btn-del" onclick="removeFromBasket('${s.code}')">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('register-credit-basket').textContent = totalCredit;
      document.getElementById('register-count-basket').textContent = list.length;
    }

    function renderRegisterListInTab3() {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      const tbody = document.getElementById('register-table-tab3');
      if (!tbody) return;
      
      tbody.innerHTML = '';

      if (list.length === 0) {
        document.getElementById('register-credit-tab3').textContent = '0';
        document.getElementById('register-count-tab3').textContent = '0';
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>';
        return;
      }

      let totalCredit = 0;
      list.forEach((s, i) => {
        totalCredit += parseInt(s.credit, 10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${s.cap}</td>
          <td><button class="btn-del" onclick="removeFromRegister('${s.code}')">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('register-credit-tab3').textContent = totalCredit;
      document.getElementById('register-count-tab3').textContent = list.length;
    }

    function quickAddToBasket() {
      const code = document.getElementById('quick-code').value.trim();
      const classNum = document.getElementById('quick-class').value.trim();

      if (!code) {
        alert('과목코드를 입력해주세요.');
        return;
      }

      const subject = allSubjects.find(s => s.code === code);
      if (!subject) {
        alert('해당 과목을 찾을 수 없습니다.');
        return;
      }

      let basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
      if (basketList.find(s => s.code === code)) {
        alert('이미 예비수강에 있습니다.');
        return;
      }

      QueueModal.showApply(function() {
        basketList.push(subject);
        localStorage.setItem('basketList', JSON.stringify(basketList));
        alert('예비수강에 추가되었습니다.');
        document.getElementById('quick-code').value = '';
        document.getElementById('quick-class').value = '';
        document.getElementById('quick-code').focus();
        filterCourses(currentSearchType);
        renderBasketListInTab2();
      });
    }

    window.quickAddToBasket = quickAddToBasket;

    function initializeApp() {
      console.log('initializeApp called');
      
      initRadioFormSwitch();
      console.log('[initializeApp] initDepts1 시작');
      initDepts1();
      console.log('[initializeApp] initDepts1 완료');
      
      console.log('[initializeApp] initIsuTypes 시작');
      initIsuTypes();
      console.log('[initializeApp] initIsuTypes 완료');
      
      console.log('[initializeApp] initMultipleTypes 시작');
      initMultipleTypes();
      console.log('[initializeApp] initMultipleTypes 완료');

      renderBasketListInTab2();
      renderRegisterListInTab3();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        initializeApp();
      });
    } else {
      console.log('DOM already loaded, initializing now');
      initializeApp();
    }
  </script>
</body>
</html>
