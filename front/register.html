<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>수강신청</title>
  <link rel="stylesheet" href="../common/style.css">
  <link rel="stylesheet" href="../css/register.css">
</head>
<body>
  <!-- 대기열 모달 (메시지 스타일) -->
  <div id="queue-modal" style="display:none;">
    <div>
      <div class="title" id="queue-title">신청 대기</div>
      <div class="message" id="queue-message">잠시만 기다려주세요... (0초)</div>
    </div>
  </div>

  <!-- 탭 + 빠른신청 -->
  <div class="tabs-container">
    <ul class="sw-tabs">
      <li data-tab="tab-1" class="is-active">개설과목</li>
      <li data-tab="tab-2">예비수강내역</li>
      <li data-tab="tab-3">수강신청내역</li>
    </ul>
    <div class="quick-request">
      <label>빠른신청</label>
      <span style="color: #666;">과목코드.분반 :</span>
      <input type="text" id="quick-code" class="code-input" placeholder="" />
      <span class="separator">-</span>
      <input type="text" id="quick-class" class="class-input" placeholder="001" />
      <button onclick="quickAddToRegister()">신청</button>
    </div>
  </div>

  <div class="sw-tab-contents">
    <!-- 탭 1: 개설과목 + 수강신청 내역 -->
    <div id="tab-1" class="is-active">
      <!-- 검색 폼 -->
      <div style="padding:8px 0;">
        <div class="radio-group" id="idSearchType" style="display: inline-flex; gap:8px;">
          <input type="radio" name="pSearchType" id="pSearchType1" value="1" checked=""><label for="pSearchType1" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">전공 / 학과</label>
          <input type="radio" name="pSearchType" id="pSearchType2" value="2"><label for="pSearchType2" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">이수구분</label>
          <input type="radio" name="pSearchType" id="pSearchType3" value="3"><label for="pSearchType3" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">다전공</label>
          <input type="radio" name="pSearchType" id="pSearchType0" value="0"><label for="pSearchType0" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">과목검색</label>
        </div>
      </div>

      <div class="form-search" id="idSearchDiv">
        <!-- 1: 학부 / 학과 -->
        <div id="idMajor" style="display: block;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThSust1">학부</th>
                <td id="idTdSust1">
                  <select name="pSustCd1" id="pSustCd1"></select>
                </td>
                <th id="idThMajor1">학과</th>
                <td id="idTdMajor1">
                  <select name="pMajorCd1" id="pMajorCd1"><option value="">전체학과</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm1" id="pLectNm1" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch1" onclick="filterCourses('1')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 2: 이수구분 -->
        <div id="idIsu" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>이수구분</th>
                <td>
                  <select name="pIsuCd2" id="pIsuCd2"><option value="전공필수">전공필수</option><option value="전공선택">전공선택</option><option value="전공기초">전공기초</option><option value="교양필수">교양필수</option><option value="교양선택">교양선택</option><option value="채플">채플</option><option value="연계필수">연계필수</option><option value="연계선택">연계선택</option></select>
                </td>
                <th id="idThSelect2" style="display: none;">교양선택</th>
                <td id="idTdSelect2" style="display: none;">
                  <select name="pSelectCd2" id="pSelectCd2"><option value="CMF024001">핵심</option><option value="CMF024002">자유</option></select>
                </td>
                <th id="idThDown2" style="display: none;">하위영역</th>
                <td id="idTdDown2" style="display: none;">
                  <select name="pDownCd2" id="pDownCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThSust2">학부</th>
                <td id="idTdSust2">
                  <select name="pSustCd2" id="pSustCd2"></select>
                </td>
                <th id="idThMajor2">학과</th>
                <td id="idTdMajor2">
                  <select name="pMajorCd2" id="pMajorCd2"><option value="">전체학과</option></select>
                </td>
                <th id="idThArea2" style="display: none;">영역</th>
                <td id="idTdArea2" style="display: none;">
                  <select name="pAreaCd2" id="pAreaCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option><option value="CMF004033">융복합</option><option value="">전체</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm2" id="pLectNm2" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch2" onclick="filterCourses('2')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 3: 다전공 -->
        <div id="idMultiple" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="220px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThMultiple3">다전공</th>
                <td id="idTdMultiple3">
                  <select name="pMultiCd3" id="pMultiCd3"></select>
                </td>
                <th id="idThSust3">학부</th>
                <td id="idTdSust3">
                  <select name="pSustCd3" id="pSustCd3"></select>
                </td>
                <th id="idThMajor3">학과</th>
                <td id="idTdMajor3">
                  <select name="pMajorCd3" id="pMajorCd3"><option value="">전체학과</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThComposite3" style="display: none;">융복합</th>
                <td id="idTdComposite3" style="display: none;">
                  <select name="pComplexCd3" id="pComplexCd3"><option value="">선택안함</option><option value="U0130010000">청소년전공</option><option value="U0130020000">글로벌외국어통상무역전공</option><option value="U0130030000">스포츠헬스케어전공</option><option value="U0130040000">멀티미디어사운드&amp;뮤직</option></select>
                </td>
                <th id="idThMicro3" style="display: none;">마이크로전공</th>
                <td id="idTdMicro3" style="display: none;">
                  <select name="pMicroCd3" id="pMicroCd3"><option value="">선택안함</option><option value="CMI012001">디지털마케팅전문가과정</option><option value="CMI012002">창의융합예술교육전문학위과정</option><option value="CMI012003">HSK교육전문가과정</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm3" id="pLectNm3" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch3" onclick="filterCourses('3')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 4: 과목검색 -->
        <div id="idSearch" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="280px">
              <col width="10px">
              <col width="120px">
              <col width="10px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>조회</th>
                <td>
                  <input name="pLectNm0" id="pLectNm0" style="width: 250px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch0" onclick="filterCourses('0')">조회</button></td>
                <th></th>
                <td>
                  <p style="font-size: 11px; color: #1976d2; margin: 0;"><b>검색명을 입력하고 엔터를 누르거나 조회 버튼을 눌러 조회하세요</b></p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 개설과목 결과 -->
      <div class="sw-header">
        <div>
          <h1>개설과목 조회<small> &gt; <span id="search-title">계절학기</span></small></h1>
        </div>
        <div class="actions">
          <div class="info-group">
            <label>Total :</label>
            <span class="txt-red"><em id="total-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="height: 96px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">신청</th>
            </tr>
          </thead>
          <tbody id="course-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">조회버튼을 클릭하여 개설교과목을 조회하세요.</td></tr>
          </tbody>
        </table>
      </div>

      

      <!-- 수강신청 내역 -->
      <div class="sw-header">
        <h1>수강신청 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="register-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 3px; margin-bottom: 15px;">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>

    <!-- 탭 2: 예비수강 내역조회 -->
    <div id="tab-2">
      <div class="sw-header">
        <h1>예비수강 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="basket-credit">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="basket-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="basket-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">예비수강이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="form-search">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>

    <!-- 탭 3: 수강신청내역 -->
    <div id="tab-3">
      <div class="sw-header">
        <h1>수강신청 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit-tab3">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count-tab3">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 350px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
              <th style="width: 70px;">삭제</th>
            </tr>
          </thead>
          <tbody id="register-table-tab3">
            <tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 3px; margin-bottom: 15px;">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="../js/data_from_real.js"></script>
  <script src="../js/queue.js"></script>
  <script>
    let allSubjects = [];
    let currentSearchType = '1'; // 현재 검색 타입
    
    // 데이터 로드 확인
    if (typeof subjects !== 'undefined' && Array.isArray(subjects)) {
      allSubjects = subjects;
      console.log('allSubjects loaded:', allSubjects.length, 'items');
    } else {
      console.error('subjects is not defined or not an array');
    }

    // 라디오 버튼 change 이벤트 - 검색 폼 전환
    function initRadioFormSwitch() {
      const radios = document.querySelectorAll('input[name="pSearchType"]');
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          currentSearchType = this.value;
          switchSearchForm(this.value);
        });
      });
    }

    // 검색 폼 전환 함수
    function switchSearchForm(searchType) {
      // 모든 폼 숨김
      document.getElementById('idMajor').style.display = 'none';
      document.getElementById('idIsu').style.display = 'none';
      document.getElementById('idMultiple').style.display = 'none';
      document.getElementById('idSearch').style.display = 'none';

      // 선택된 폼 표시 및 필요시 초기화
      console.log('[switchSearchForm] searchType:', searchType);
      switch(searchType) {
        case '1':
          document.getElementById('idMajor').style.display = 'block';
          break;
        case '2':
          document.getElementById('idIsu').style.display = 'block';
          console.log('[switchSearchForm] Type 2 표시 - fnComboMajorFilter(2) 호출');
          fnComboMajorFilter('2');
          break;
        case '3':
          document.getElementById('idMultiple').style.display = 'block';
          console.log('[switchSearchForm] Type 3 표시 - fnComboMajorFilter(3) 호출');
          fnComboMajorFilter('3');
          break;
        case '0':
          document.getElementById('idSearch').style.display = 'block';
          break;
      }
    }

    // 탭 전환
    document.querySelectorAll('.sw-tabs li').forEach(li => {
      li.onclick = function() {
        const tabId = this.dataset.tab;
        document.querySelectorAll('.sw-tabs li').forEach(l => l.classList.remove('is-active'));
        document.querySelectorAll('.sw-tab-contents > div').forEach(d => d.classList.remove('is-active'));
        this.classList.add('is-active');
        document.getElementById(tabId).classList.add('is-active');
        
        if (tabId === 'tab-2') renderBasketListInTab2();
        if (tabId === 'tab-3') renderRegisterListInTab3();
      };
    });

    // 학부 초기화 (검색 타입 1)
    function initDepts1() {
      const select = document.getElementById('pSustCd1');
      if (!select) return;
      
      select.innerHTML = '';
      // 예비수강 옵션 추가
      const grade = localStorage.getItem('userGrade') || '2';
      const basketOpt = document.createElement('option');
      basketOpt.value = 'basket';
      basketOpt.textContent = '예비수강';
      if (grade === '1') basketOpt.disabled = true;
      select.appendChild(basketOpt);
      
      // 학부 추가
      const depts = [...new Set(allSubjects
        .map(s => s.dept)
        .filter(d => d && String(d).trim()))]
        .sort();
      
      depts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        select.appendChild(opt);
      });

      console.log('[initDepts1] pSustCd1 옵션 추가됨:', depts.length + 1);

      // 초기값 설정 및 이벤트 리스너 추가
      if (select.options.length > 0) {
        select.value = select.options[0].value;
        console.log('[initDepts1] pSustCd1 초기값 설정:', select.options[0].value);
        
        // pSustCd1 change 이벤트 (fnComboMajorFilter 호출)
        select.addEventListener('change', function() {
          console.log('[pSustCd1 change event] value:', this.value);
          fnComboMajorFilter('1');
        });
        
        // 초기 학과 필터링 실행
        console.log('[initDepts1] fnComboMajorFilter(1) 호출');
        fnComboMajorFilter('1');
      }
    }

    // 학과 필터링 (검색 타입 1)
    // 학부/학과 필터링 - 모든 검색 타입 통합 처리
    function fnComboMajorFilter(type) {
      console.log('[fnComboMajorFilter] type:', type);
      
      if (type === '1') {
        const deptSelect = document.getElementById('pSustCd1');
        const majorSelect = document.getElementById('pMajorCd1');
        const deptValue = deptSelect?.value;
        const majorThRow = document.getElementById('idThMajor1');
        const majorTdRow = document.getElementById('idTdMajor1');
        
        console.log('[fnComboMajorFilter-1] deptValue:', deptValue);
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        // 예비수강 선택 시 학과 영역 숨김
        if (deptValue === 'basket') {
          console.log('[fnComboMajorFilter-1] 예비수강 선택 - 학과 영역 숨김');
          majorThRow.style.display = 'none';
          majorTdRow.style.display = 'none';
        } else {
          majorThRow.style.display = '';
          majorTdRow.style.display = '';
          if (deptValue) {
            const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
            console.log('[fnComboMajorFilter-1] allSubjects majors:', majors);
            majors.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              majorSelect.appendChild(opt);
            });
          }
        }
      }
      
      if (type === '2') {
        const deptSelect = document.getElementById('pSustCd2');
        const majorSelect = document.getElementById('pMajorCd2');
        const deptValue = deptSelect?.value;
        
        console.log('[fnComboMajorFilter-2] deptValue:', deptValue);
        
        if (!majorSelect) {
          console.error('[fnComboMajorFilter-2] majorSelect(pMajorCd2)이 없음!');
          return;
        }
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        if (deptValue) {
          const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
          console.log('[fnComboMajorFilter-2] majors:', majors);
          majors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
          });
          console.log('[fnComboMajorFilter-2] 완료 - 추가 옵션 수:', majors.length);
        } else {
          console.log('[fnComboMajorFilter-2] deptValue 비어있음');
        }
      }
      
      if (type === '3') {
        const deptSelect = document.getElementById('pSustCd3');
        const majorSelect = document.getElementById('pMajorCd3');
        const deptValue = deptSelect?.value;
        
        console.log('[fnComboMajorFilter-3] deptValue:', deptValue);
        
        if (!majorSelect) {
          console.error('[fnComboMajorFilter-3] majorSelect(pMajorCd3)이 없음!');
          return;
        }
        
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        
        if (deptValue) {
          const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
          console.log('[fnComboMajorFilter-3] majors:', majors);
          majors.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            majorSelect.appendChild(opt);
          });
          console.log('[fnComboMajorFilter-3] 완료 - 추가 옵션 수:', majors.length);
        } else {
          console.log('[fnComboMajorFilter-3] deptValue 비어있음');
        }
      }
    }

    // 이수구분 필터링 (검색 타입 2)
    function fnComboIsuFilter(type) {
      console.log('[fnComboIsuFilter] type:', type);
      if (type === '2') {
        const isuSelect = document.getElementById('pIsuCd2');
        const isuValue = isuSelect.value;
        
        // 교양선택 선택 여부에 따라 추가 옵션 표시
        const selectRow = document.getElementById('idThSelect2');
        const downRow = document.getElementById('idThDown2');
        
        console.log('[fnComboIsuFilter-2] isuValue:', isuValue);
        
        if (isuValue === '교양선택') { // 교양선택 선택
          selectRow.style.display = '';
          document.getElementById('idTdSelect2').style.display = '';
          downRow.style.display = '';
          document.getElementById('idTdDown2').style.display = '';
        } else {
          selectRow.style.display = 'none';
          document.getElementById('idTdSelect2').style.display = 'none';
          downRow.style.display = 'none';
          document.getElementById('idTdDown2').style.display = 'none';
        }
      }
    }

    // 학부 필터링 (검색 타입 2)
    // 이수구분 select 초기화 및 학부 초기화 (검색 타입 2)
    function initIsuTypes() {
      const select = document.getElementById('pIsuCd2');
      if (!select) return;
      
      select.innerHTML = '';
      const types = [
        { text: '전공필수' },
        { text: '전공선택' },
        { text: '전공기초' },
        { text: '교양필수' },
        { text: '교양선택' },
        { text: '채플' },
        { text: '연계필수' },
        { text: '연계선택' }
      ];
      
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type.text;
        opt.textContent = type.text;
        select.appendChild(opt);
      });
      
      // pIsuCd2 change 이벤트 (fnComboIsuFilter 호출)
      select.addEventListener('change', function() {
        console.log('[pIsuCd2 change event] value:', this.value);
        fnComboIsuFilter('2');
      });

      // 교양선택 options
      const selectCd = document.getElementById('pSelectCd2');
      if (selectCd) {
        selectCd.innerHTML = '';
        ['핵심', '자유'].forEach((text) => {
          const opt = document.createElement('option');
          opt.value = text;
          opt.textContent = text;
          selectCd.appendChild(opt);
        });
      }

      // 하위영역 options
      const downCd = document.getElementById('pDownCd2');
      if (downCd) {
        downCd.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          downCd.appendChild(opt);
        });
      }

      // 영역 options
      const areaCd = document.getElementById('pAreaCd2');
      if (areaCd) {
        areaCd.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' },
          { value: '융복합', text: '융복합' },
          { value: '', text: '전체' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          areaCd.appendChild(opt);
        });
      }

      // 학부 초기화
      const sustSelect = document.getElementById('pSustCd2');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        console.log('[initIsuTypes] pSustCd2 옵션 추가됨:', depts.length);
        
        // 초기값 설정 및 이벤트 리스너 추가
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          console.log('[initIsuTypes] pSustCd2 초기값 설정:', depts[0]);
          
          // pSustCd2 change 이벤트 (fnComboMajorFilter 호출)
          sustSelect.addEventListener('change', function() {
            console.log('[pSustCd2 change event] value:', this.value);
            fnComboMajorFilter('2');
          });
          
          // 초기 학과 필터링 실행
          console.log('[initIsuTypes] fnComboMajorFilter(2) 호출');
          fnComboMajorFilter('2');
        }
      }

      // 학과 초기화 (pMajorCd2)
      const majorSelect = document.getElementById('pMajorCd2');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        console.log('[initIsuTypes] pMajorCd2 초기화됨');
      }
    }

    // 다전공 선택에 따라 조건부 옵션 표시/숨김 (검색 타입 3)
    function fnChkVal(type) {
      if (type === '3') {
        const multiValue = document.getElementById('pMultiCd3').value;
        const compositeRow = document.getElementById('idThComposite3');
        const microRow = document.getElementById('idThMicro3');

        // 융복합전공일 때만 융복합 옵션 표시
        if (multiValue === 'CMF005008') {
          compositeRow.style.display = '';
          document.getElementById('idTdComposite3').style.display = '';
        } else {
          compositeRow.style.display = 'none';
          document.getElementById('idTdComposite3').style.display = 'none';
        }

        // 마이크로전공일 때만 마이크로전공 옵션 표시
        if (multiValue === 'CMF005009') {
          microRow.style.display = '';
          document.getElementById('idTdMicro3').style.display = '';
        } else {
          microRow.style.display = 'none';
          document.getElementById('idTdMicro3').style.display = 'none';
        }
      }
    }

    // 학부 필터링 (검색 타입 3)
    // 다전공 select 초기화 (검색 타입 3)
    function initMultipleTypes() {
      const select = document.getElementById('pMultiCd3');
      if (!select) return;
      
      select.innerHTML = '';
      const types = [
        { value: 'CMF005001', text: '부전공' },
        { value: 'CMF005002', text: '복수전공' },
        { value: 'CMF005008', text: '융복합전공' },
        { value: 'CMF005009', text: '마이크로전공' }
      ];
      
      types.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type.value;
        opt.textContent = type.text;
        select.appendChild(opt);
      });

      // pMultiCd3 change 이벤트 (fnComboMajorFilter, fnChkVal 호출)
      select.addEventListener('change', function() {
        console.log('[pMultiCd3 change event] value:', this.value);
        fnComboMajorFilter('3');
        fnChkVal('3');
      });

      // 학부 초기화
      const sustSelect = document.getElementById('pSustCd3');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        console.log('[initMultipleTypes] pSustCd3 옵션 추가됨:', depts.length);
        
        // 초기값 설정 및 이벤트 리스너 추가
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          console.log('[initMultipleTypes] pSustCd3 초기값 설정:', depts[0]);
          
          // pSustCd3 change 이벤트 (fnComboMajorFilter 호출)
          sustSelect.addEventListener('change', function() {
            console.log('[pSustCd3 change event] value:', this.value);
            fnComboMajorFilter('3');
          });
          
          // 초기 학과 필터링 실행
          console.log('[initMultipleTypes] fnComboMajorFilter(3) 호출');
          fnComboMajorFilter('3');
        }
      }

      // 학과 초기화 (pMajorCd3)
      const majorSelect = document.getElementById('pMajorCd3');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
        console.log('[initMultipleTypes] pMajorCd3 초기화됨');
      }

      // 융복합 옵션 초기화
      const complexCd = document.getElementById('pComplexCd3');
      if (complexCd) {
        complexCd.innerHTML = '';
        const complexes = [
          { value: '', text: '선택안함' },
          { value: 'U0130010000', text: '청소년전공' },
          { value: 'U0130020000', text: '글로벌외국어통상무역전공' },
          { value: 'U0130030000', text: '스포츠헬스케어전공' },
          { value: 'U0130040000', text: '멀티미디어사운드&뮤직' }
        ];
        complexes.forEach(complex => {
          const opt = document.createElement('option');
          opt.value = complex.value;
          opt.textContent = complex.text;
          complexCd.appendChild(opt);
        });
      }

      // 마이크로전공 옵션 초기화
      const microCd = document.getElementById('pMicroCd3');
      if (microCd) {
        microCd.innerHTML = '';
        const micros = [
          { value: '', text: '선택안함' },
          { value: 'CMI012001', text: '디지털마케팅전문가과정' },
          { value: 'CMI012002', text: '창의융합예술교육전문학위과정' },
          { value: 'CMI012003', text: 'HSK교육전문가과정' }
        ];
        micros.forEach(micro => {
          const opt = document.createElement('option');
          opt.value = micro.value;
          opt.textContent = micro.text;
          microCd.appendChild(opt);
        });
      }
    }

    // 과목 필터링 (검색 타입별로 다른 필터 적용)
    function filterCourses(searchType = null) {
      if (searchType === null) searchType = currentSearchType;
      console.log('[filterCourses] searchType:', searchType, 'allSubjects:', allSubjects.length);

      let filtered = [];

      if (searchType === '1') {
        // 학부/학과 검색
        const dept = document.getElementById('pSustCd1')?.value || '';
        const major = document.getElementById('pMajorCd1')?.value || '';
        const search = (document.getElementById('pLectNm1')?.value || '').toLowerCase();

        console.log('[filterCourses-1] dept:', dept, 'major:', major, 'search:', search);

        if (dept === 'basket') {
          const basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
          filtered = basketList.filter(s => {
            if (major && s.major !== major) return false;
            if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
            return true;
          });
        } else if (dept) {
          filtered = allSubjects.filter(s => {
            if (s.dept !== dept) return false;
            if (major && s.major !== major) return false;
            if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
            return true;
          });
        }
      } else if (searchType === '2') {
        // 이수구분 검색
        const type = document.getElementById('pIsuCd2')?.value || '';
        const sustValue = document.getElementById('pSustCd2')?.value || '';
        const majorValue = document.getElementById('pMajorCd2')?.value || '';
        const search = (document.getElementById('pLectNm2')?.value || '').toLowerCase();

        console.log('[filterCourses-2] type:', type, 'sustValue:', sustValue, 'majorValue:', majorValue, 'search:', search);

        filtered = allSubjects.filter(s => {
          if (type && s.type !== type) {
            console.log('[type check failed] expected:', type, 'got:', s.type, 'course:', s.name);
            return false;
          }
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
        console.log('[filterCourses-2] filtered count:', filtered.length);
      } else if (searchType === '3') {
        // 다전공 검색
        const multiValue = document.getElementById('pMultiCd3')?.value || '';
        const sustValue = document.getElementById('pSustCd3')?.value || '';
        const majorValue = document.getElementById('pMajorCd3')?.value || '';
        const search = (document.getElementById('pLectNm3')?.value || '').toLowerCase();

        console.log('[filterCourses-3] multiValue:', multiValue, 'sustValue:', sustValue, 'majorValue:', majorValue, 'search:', search);

        filtered = allSubjects.filter(s => {
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
        console.log('[filterCourses-3] filtered count:', filtered.length);
      } else if (searchType === '0') {
        // 과목 직접 검색
        const search = (document.getElementById('pLectNm0')?.value || '').toLowerCase();
        filtered = allSubjects.filter(s => {
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
      }

      document.getElementById('total-count').textContent = filtered.length;
      const tbody = document.getElementById('course-table');
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">검색 결과가 없습니다.</td></tr>';
        return;
      }

      filtered.forEach((s, i) => {
        const cap = s.cap !== undefined ? s.cap : 30;
        const isAdded = JSON.parse(localStorage.getItem('registerList') || '[]').some(r => r.code === s.code);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${cap}</td>
          <td>
            ${isAdded ? '<span style="color:#d32f2f;">신청</span>' : '<button class="btn-add" onclick="addToRegister(\''+s.code+'\', \''+s.name+'\', \''+s.dept+'\', \''+s.major+'\', \''+s.year+'\', \''+s.type+'\', \''+s.credit+'\', \''+cap+'\')">신청</button>'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 수강신청 추가
    function addToRegister(code, name, dept, major, year, type, credit, cap) {
      QueueModal.showApply(function() {
        if (!dept || !dept.trim() || !major || !major.trim()) {
          alert('유효한 과목이 아닙니다.');
          return;
        }

        let list = JSON.parse(localStorage.getItem('registerList') || '[]');
        if (list.find(s => s.code === code)) {
          alert('이미 신청한 과목입니다.');
          return;
        }
        list.push({ code, name, dept, major, year, type, credit, cap });
        localStorage.setItem('registerList', JSON.stringify(list));
        filterCourses(currentSearchType);
        renderRegisterList();
      });
    }

    // 수강신청 삭제
    function removeFromRegister(code) {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      list = list.filter(s => s.code !== code);
      localStorage.setItem('registerList', JSON.stringify(list));
      filterCourses(currentSearchType);
      renderRegisterList();
    }

    // 수강신청 목록 렌더링
    function renderRegisterList() {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      const tbody = document.getElementById('register-table');
      tbody.innerHTML = '';

      if (list.length === 0) {
        document.getElementById('register-credit').textContent = '0';
        document.getElementById('register-count').textContent = '0';
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>';
        return;
      }

      let totalCredit = 0;
      list.forEach((s, i) => {
        totalCredit += parseInt(s.credit, 10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${s.cap}</td>
          <td><button class="btn-del" onclick="removeFromRegister('${s.code}')">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('register-credit').textContent = totalCredit;
      document.getElementById('register-count').textContent = list.length;
    }

    // Tab 2: basketList 렌더링 (예비수강내역)
    function renderBasketListInTab2() {
      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      const tbody = document.getElementById('basket-table');
      tbody.innerHTML = '';

      if (list.length === 0) {
        document.getElementById('basket-credit').textContent = '0';
        document.getElementById('basket-count').textContent = '0';
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">예비수강이 없습니다.</td></tr>';
        return;
      }

      let totalCredit = 0;
      list.forEach((s, i) => {
        totalCredit += parseInt(s.credit, 10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${s.cap}</td>
          <td><button class="btn-del" onclick="removeBasketFromTab2('${s.code}')">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('basket-credit').textContent = totalCredit;
      document.getElementById('basket-count').textContent = list.length;
    }

    // Tab 2에서 basketList 삭제
    function removeBasketFromTab2(code) {
      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      list = list.filter(s => s.code !== code);
      localStorage.setItem('basketList', JSON.stringify(list));
      renderBasketListInTab2();
    }

    // Tab 3: registerList 렌더링 (수강신청내역)
    function renderRegisterListInTab3() {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      const tbody = document.getElementById('register-table-tab3');
      tbody.innerHTML = '';

      if (list.length === 0) {
        document.getElementById('register-credit-tab3').textContent = '0';
        document.getElementById('register-count-tab3').textContent = '0';
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>';
        return;
      }

      let totalCredit = 0;
      list.forEach((s, i) => {
        totalCredit += parseInt(s.credit, 10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${s.cap}</td>
          <td><button class="btn-del" onclick="removeRegisterFromTab3('${s.code}')">삭제</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('register-credit-tab3').textContent = totalCredit;
      document.getElementById('register-count-tab3').textContent = list.length;
    }

    // Tab 3에서 registerList 삭제
    function removeRegisterFromTab3(code) {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      list = list.filter(s => s.code !== code);
      localStorage.setItem('registerList', JSON.stringify(list));
      renderRegisterListInTab3();
    }

    // 빠른수강신청 함수
    function quickAddToRegister() {
      const code = document.getElementById('quick-code').value.trim();
      const classNum = document.getElementById('quick-class').value.trim();

      if (!code) {
        alert('과목코드를 입력해주세요.');
        return;
      }

      const subject = allSubjects.find(s => s.code === code);
      if (!subject) {
        alert('해당 과목을 찾을 수 없습니다.');
        return;
      }

      let registerList = JSON.parse(localStorage.getItem('registerList') || '[]');
      if (registerList.find(s => s.code === code)) {
        alert('이미 수강신청에 있습니다.');
        return;
      }

      QueueModal.showApply(function() {
        registerList.push(subject);
        localStorage.setItem('registerList', JSON.stringify(registerList));

        alert('수강신청에 추가되었습니다.');
        document.getElementById('quick-code').value = '';
        document.getElementById('quick-class').value = '';
        document.getElementById('quick-code').focus();

        filterCourses(currentSearchType);
        renderRegisterList();
      });
    }

    // 초기화
    function initializeApp() {
      console.log('initializeApp called, allSubjects.length:', allSubjects.length);
      
      // 라디오 버튼 이벤트 리스너 추가
      initRadioFormSwitch();
      
      // 각 검색 타입별 select 초기화
      console.log('[initializeApp] initDepts1 시작');
      initDepts1();
      console.log('[initializeApp] initDepts1 완료');
      
      console.log('[initializeApp] initIsuTypes 시작');
      initIsuTypes();
      console.log('[initializeApp] initIsuTypes 완료');
      
      console.log('[initializeApp] initMultipleTypes 시작');
      initMultipleTypes();
      console.log('[initializeApp] initMultipleTypes 완료');

      // 예비수강이 있으면 자동으로 예비수강 기준으로 조회 실행
      try {
        const basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
        if (Array.isArray(basketList) && basketList.length > 0) {
          const deptSelect = document.getElementById('pSustCd1');
          if (deptSelect) {
            deptSelect.value = 'basket';
            deptSelect.dispatchEvent(new Event('change'));
            filterCourses('1');
            console.log('[initializeApp] auto-filter by basket applied');
          }
        }
      } catch (e) {
        console.warn('[initializeApp] basket auto-filter failed', e);
      }

      renderRegisterList();
      renderBasketListInTab2();
      renderRegisterListInTab3();
    }
    
    // DOM 로드 후 초기화
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        initializeApp();
      });
    } else {
      console.log('DOM already loaded, initializing now');
      initializeApp();
    }
  </script>
</body>
</html>
