<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>수강신청</title>
  <link rel="stylesheet" href="../common/style.css">
  <link rel="stylesheet" href="../css/register.css">
</head>
<body>
  <!-- 대기열 모달 (메시지 스타일) -->
  <div id="queue-modal" style="display:none;">
    <div>
      <div class="title" id="queue-title">신청 대기</div>
      <div class="message" id="queue-message">잠시만 기다려주세요... (0초)</div>
    </div>
  </div>

  <!-- 탭 + 빠른신청 -->
  <div class="tabs-container">
    <ul class="sw-tabs">
      <li id="tab-1-menu" data-tab="tab-1" class="is-active">예비수강신청</li>
      <li data-tab="tab-2">개설과목</li>
    </ul>
    <div class="quick-request">
      <label>빠른신청</label>
      <span style="color: #666;">과목코드.분반 :</span>
      <input type="text" id="quick-code" class="code-input" placeholder="" />
      <span class="separator">-</span>
      <input type="text" id="quick-class" class="class-input" placeholder="001" />
      <button onclick="quickAddToRegister()">신청</button>
    </div>
  </div>

  <div class="sw-tab-contents">
    <!-- 탭 1: 예비수강신청 (검색 + 신청 + 내역) -->
    <div id="tab-1" class="is-active">
      <!-- 검색 결과 -->
      <div class="sw-header">
        <div>
          <h1>예비수강 조회<small> &gt; <span id="search-title-tab1">계절학기</span></small></h1>
        </div>
        <div class="actions">
          <div class="info-group">
            <label>Total :</label>
            <span class="txt-red"><em id="total-count-tab1">0</em></span>
          </div>
        </div>
      </div>

      <div style="height: 96px; overflow-y: auto; margin-bottom: 30px;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 70px;">신청</th>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
            </tr>
          </thead>
          <tbody id="course-table-tab1">
            <tr><td colspan="10" style="text-align:center; color:#999;">조회버튼을 클릭하여 예비수강 과목을 조회하세요.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 신청 내역 -->
      <div class="sw-header">
        <h1>신청 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit-tab1">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count-tab1">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 600px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 70px;">삭제</th>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
            </tr>
          </thead>
          <tbody id="register-table-tab1">
            <tr><td colspan="10" style="text-align:center; color:#999;">신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="form-search">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>

    <!-- 탭 2: 개설과목 조회 -->
    <div id="tab-2">
      <!-- 검색 폼 -->
      <div style="padding:8px 0;">
        <div class="radio-group" id="idSearchType" style="display: inline-flex; gap:8px;">
          <input type="radio" name="pSearchType" id="pSearchType1" value="1" checked=""><label for="pSearchType1" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">전공 / 학과</label>
          <input type="radio" name="pSearchType" id="pSearchType2" value="2"><label for="pSearchType2" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">이수구분</label>
          <input type="radio" name="pSearchType" id="pSearchType3" value="3"><label for="pSearchType3" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">다전공</label>
          <input type="radio" name="pSearchType" id="pSearchType0" value="0"><label for="pSearchType0" style="min-width: 100px;min-height: 30px;display:flex;align-items:center;justify-content:center;">과목검색</label>
        </div>
      </div>

      <div class="form-search" id="idSearchDiv">
        <!-- 1: 학부 / 학과 -->
        <div id="idMajor" style="display: block;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThSust1">학부</th>
                <td id="idTdSust1">
                  <select name="pSustCd1" id="pSustCd1"></select>
                </td>
                <th id="idThMajor1">학과</th>
                <td id="idTdMajor1">
                  <select name="pMajorCd1" id="pMajorCd1"><option value="">전체학과</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm1" id="pLectNm1" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch1" onclick="filterCourses('1')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 2: 이수구분 -->
        <div id="idIsu" style="display: none;" class="search-section">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="200px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>이수구분</th>
                <td>
                  <select name="pIsuCd2" id="pIsuCd2"><option value="전공필수">전공필수</option><option value="전공선택">전공선택</option><option value="전공기초">전공기초</option><option value="교양필수">교양필수</option><option value="교양선택">교양선택</option><option value="채플">채플</option><option value="연계필수">연계필수</option><option value="연계선택">연계선택</option></select>
                </td>
                <th id="idThSelect2" style="display: none;">교양선택</th>
                <td id="idTdSelect2" style="display: none;">
                  <select name="pSelectCd2" id="pSelectCd2"><option value="CMF024001">핵심</option><option value="CMF024002">자유</option></select>
                </td>
                <th id="idThDown2" style="display: none;">하위영역</th>
                <td id="idTdDown2" style="display: none;">
                  <select name="pDownCd2" id="pDownCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThSust2">학부</th>
                <td id="idTdSust2">
                  <select name="pSustCd2" id="pSustCd2"></select>
                </td>
                <th id="idThMajor2">학과</th>
                <td id="idTdMajor2">
                  <select name="pMajorCd2" id="pMajorCd2"><option value="">전체학과</option></select>
                </td>
                <th id="idThArea2" style="display: none;">영역</th>
                <td id="idTdArea2" style="display: none;">
                  <select name="pAreaCd2" id="pAreaCd2"><option value="CMF004028">C(창의성)</option><option value="CMF004029">H(나눔·배려)</option><option value="CMF004030">A(비판·분석적사고)</option><option value="CMF004031">M(소통)</option><option value="CMF004032">P(문제해결)</option><option value="CMF004033">융복합</option><option value="">전체</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm2" id="pLectNm2" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch2" onclick="filterCourses('2')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 3: 다전공 -->
        <div id="idMultiple" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="150px">
              <col width="80px">
              <col width="220px">
              <col width="80px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th id="idThMultiple3">다전공</th>
                <td id="idTdMultiple3">
                  <select name="pMultiCd3" id="pMultiCd3"></select>
                </td>
                <th id="idThSust3">학부</th>
                <td id="idTdSust3">
                  <select name="pSustCd3" id="pSustCd3"></select>
                </td>
                <th id="idThMajor3">학과</th>
                <td id="idTdMajor3">
                  <select name="pMajorCd3" id="pMajorCd3"><option value="">전체학과</option></select>
                </td>
              </tr>
              <tr>
                <th id="idThComposite3" style="display: none;">융복합</th>
                <td id="idTdComposite3" style="display: none;">
                  <select name="pComplexCd3" id="pComplexCd3"><option value="">선택안함</option><option value="U0130010000">청소년전공</option><option value="U0130020000">글로벌외국어통상무역전공</option><option value="U0130030000">스포츠헬스케어전공</option><option value="U0130040000">멀티미디어사운드&amp;뮤직</option></select>
                </td>
                <th id="idThMicro3" style="display: none;">마이크로전공</th>
                <td id="idTdMicro3" style="display: none;">
                  <select name="pMicroCd3" id="pMicroCd3"><option value="">선택안함</option><option value="CMI012001">디지털마케팅전문가과정</option><option value="CMI012002">창의융합예술교육전문학위과정</option><option value="CMI012003">HSK교육전문가과정</option></select>
                </td>
                <th>검색</th>
                <td>
                  <input name="pLectNm3" id="pLectNm3" style="width: 200px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch3" onclick="filterCourses('3')">조회</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 4: 과목검색 -->
        <div id="idSearch" style="display: none;">
          <table>
            <colgroup>
              <col width="80px">
              <col width="280px">
              <col width="10px">
              <col width="120px">
              <col width="10px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th>조회</th>
                <td>
                  <input name="pLectNm0" id="pLectNm0" style="width: 250px;" placeholder="과목명(코드)를 입력하세요">
                </td>
                <th></th>
                <td><button type="button" class="btn-sub" id="btnSearch0" onclick="filterCourses('0')">조회</button></td>
                <th></th>
                <td>
                  <p style="font-size: 11px; color: #1976d2; margin: 0;"><b>검색명을 입력하고 엔터를 누르거나 조회 버튼을 눌러 조회하세요</b></p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 개설과목 결과 -->
      <div class="sw-header">
        <div>
          <h1>개설과목 조회<small> &gt; <span id="search-title">계절학기</span></small></h1>
        </div>
        <div class="actions">
          <div class="info-group">
            <label>Total :</label>
            <span class="txt-red"><em id="total-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="height: 96px; overflow-y: auto; margin-bottom: 30px;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 70px;">신청</th>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
            </tr>
          </thead>
          <tbody id="course-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">조회버튼을 클릭하여 개설교과목을 조회하세요.</td></tr>
          </tbody>
        </table>
      </div>

      

      <!-- 수강신청 내역 -->
      <div class="sw-header">
        <h1>수강신청 내역</h1>
        <div class="actions">
          <div class="info-group">
            <label>총 신청학점 :</label>
            <span class="txt-red"><em id="register-credit">0</em></span>
            <label style="margin-left: 20px;">신청과목수 :</label>
            <span class="txt-red"><em id="register-count">0</em></span>
          </div>
        </div>
      </div>

      <div style="max-height: 600px; overflow-y: auto;">
        <table class="result-table">
          <thead>
            <tr>
              <th style="width: 70px;">삭제</th>
              <th style="width: 80px;">학부</th>
              <th style="width: 100px;">학과</th>
              <th style="width: 50px;">학년</th>
              <th style="width: 150px;">과목명</th>
              <th style="width: 60px;">코드</th>
              <th style="width: 70px;">이수구분</th>
              <th style="width: 50px;">학점</th>
              <th style="width: 50px;">신청</th>
              <th style="width: 50px;">정원</th>
            </tr>
          </thead>
          <tbody id="register-table">
            <tr><td colspan="10" style="text-align:center; color:#999;">수강신청이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 8px 12px; border-radius: 3px; margin-bottom: 15px;">
        <ul class="list-dot">
          <li>과목코드 클릭 시 강의계획서가 조회 됩니다</li>
          <li>인원정보 : <span style="color:#2e7d32;">●</span> 잔여석 여유 | <span style="color:#f57c00;">●</span> 잔여석 보통 | <span style="color:#c62828;">●</span> 잔여석 부족 | <span style="color:#333;">●</span> 마감</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="../js/data_from_real.js"></script>
  <script src="../js/queue.js"></script>
  <script>
    let allSubjects = [];
    let currentSearchType = '1'; // 현재 검색 타입
    
    // 데이터 로드 확인
    if (typeof subjects !== 'undefined' && Array.isArray(subjects)) {
      allSubjects = subjects;
      console.log('allSubjects loaded:', allSubjects.length, 'items');
    } else {
      console.error('subjects is not defined or not an array');
    }

    // 라디오 버튼 change 이벤트 - 검색 폼 전환
    function initRadioFormSwitch() {
      // Tab-2의 라디오 버튼
      const radios = document.querySelectorAll('input[name="pSearchType"]');
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          currentSearchType = this.value;
          switchSearchForm(this.value, 'tab2');
        });
      });

      // Tab-1의 라디오 버튼
      const radios_tab1 = document.querySelectorAll('input[name="pSearchType-tab1"]');
      radios_tab1.forEach(radio => {
        radio.addEventListener('change', function() {
          currentSearchType = this.value;
          switchSearchForm(this.value, 'tab1');
        });
      });
    }

    // 검색 폼 전환 함수
    function switchSearchForm(searchType, tab = 'tab2') {
      const prefix = tab === 'tab1' ? '-tab1' : '';
      
      // 모든 폼 숨김
      document.getElementById(`idMajor${prefix}`)?.style && (document.getElementById(`idMajor${prefix}`).style.display = 'none');
      document.getElementById(`idIsu${prefix}`)?.style && (document.getElementById(`idIsu${prefix}`).style.display = 'none');
      document.getElementById(`idMultiple${prefix}`)?.style && (document.getElementById(`idMultiple${prefix}`).style.display = 'none');
      document.getElementById(`idSearch${prefix}`)?.style && (document.getElementById(`idSearch${prefix}`).style.display = 'none');

      // 선택된 폼 표시 및 필요시 초기화
      console.log('[switchSearchForm] searchType:', searchType, 'tab:', tab);
      switch(searchType) {
        case '1':
          document.getElementById(`idMajor${prefix}`).style.display = 'block';
          break;
        case '2':
          document.getElementById(`idIsu${prefix}`).style.display = 'block';
          console.log('[switchSearchForm] Type 2 표시 - fnComboMajorFilter(2) 호출');
          fnComboMajorFilter('2');
          break;
        case '3':
          document.getElementById(`idMultiple${prefix}`).style.display = 'block';
          console.log('[switchSearchForm] Type 3 표시 - fnComboMajorFilter(3) 호출');
          fnComboMajorFilter('3');
          break;
        case '0':
          document.getElementById(`idSearch${prefix}`).style.display = 'block';
          break;
      }
    }

    // 탭 전환
    document.querySelectorAll('.sw-tabs li').forEach(li => {
      li.onclick = function() {
        const tabId = this.dataset.tab;
        document.querySelectorAll('.sw-tabs li').forEach(l => l.classList.remove('is-active'));
        document.querySelectorAll('.sw-tab-contents > div').forEach(d => d.classList.remove('is-active'));
        this.classList.add('is-active');
        document.getElementById(tabId).classList.add('is-active');
        
        if (tabId === 'tab-1') {
          renderRegisterList('tab1');
          // Tab-1로 이동하면 항상 searchType '1'로 고정
          filterCourses('1', 'tab1');
        } else if (tabId === 'tab-2') {
          renderRegisterList('tab2');
          // Tab-2로 이동하면 현재 검색 조건으로 필터링 실행
          filterCourses(currentSearchType, 'tab2');
        }
      };
    });

    // 학부 초기화 (검색 타입 1) - Tab-1, Tab-2 모두 처리
    function initDepts1() {
      // Tab-2
      const select = document.getElementById('pSustCd1');
      if (select) {
        select.innerHTML = '';
        const grade = localStorage.getItem('userGrade') || '2';
        
        const depts = [...new Set(allSubjects
          .map(s => s.dept)
          .filter(d => d && String(d).trim()))]
          .sort();
        
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          select.appendChild(opt);
        });

        if (select.options.length > 0) {
          select.value = select.options[0].value;
          select.addEventListener('change', function() {
            fnComboMajorFilter('1');
          });
          fnComboMajorFilter('1');
        }
      }

      // Tab-1 (예비수강신청)
      const select_tab1 = document.getElementById('pSustCd1-tab1');
      if (select_tab1) {
        select_tab1.innerHTML = '';
        
        // 예비수강 옵션 먼저 추가
        const basketOpt = document.createElement('option');
        basketOpt.value = 'basket';
        basketOpt.textContent = '예비수강';
        select_tab1.appendChild(basketOpt);
        
        const depts = [...new Set(allSubjects
          .map(s => s.dept)
          .filter(d => d && String(d).trim()))]
          .sort();
        
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          select_tab1.appendChild(opt);
        });

        // Tab-1은 초기값을 "basket"으로 설정
        select_tab1.value = 'basket';
        select_tab1.addEventListener('change', function() {
          filterCourses('1', 'tab1');
        });
        // 초기 필터링은 initializeApp에서 처리
      }
    }

    // 학과 필터링 (검색 타입 1, 2, 3) - 모든 검색 타입 통합 처리
    function fnComboMajorFilter(type) {
      console.log('[fnComboMajorFilter] type:', type);
      
      if (type === '1') {
        // Tab-2
        const deptSelect = document.getElementById('pSustCd1');
        const majorSelect = document.getElementById('pMajorCd1');
        if (deptSelect && majorSelect) {
          const deptValue = deptSelect.value;
          const majorThRow = document.getElementById('idThMajor1');
          const majorTdRow = document.getElementById('idTdMajor1');
          
          majorSelect.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue === 'basket') {
            majorThRow.style.display = 'none';
            majorTdRow.style.display = 'none';
          } else {
            majorThRow.style.display = '';
            majorTdRow.style.display = '';
            if (deptValue) {
              const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
              majors.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                majorSelect.appendChild(opt);
              });
            }
          }
        }

        // Tab-1
        const deptSelect_tab1 = document.getElementById('pSustCd1-tab1');
        const majorSelect_tab1 = document.getElementById('pMajorCd1-tab1');
        if (deptSelect_tab1 && majorSelect_tab1) {
          const deptValue = deptSelect_tab1.value;
          const majorThRow = document.getElementById('idThMajor1-tab1');
          const majorTdRow = document.getElementById('idTdMajor1-tab1');
          
          majorSelect_tab1.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue === 'basket') {
            majorThRow.style.display = 'none';
            majorTdRow.style.display = 'none';
          } else {
            majorThRow.style.display = '';
            majorTdRow.style.display = '';
            if (deptValue) {
              const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
              majors.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                majorSelect_tab1.appendChild(opt);
              });
            }
          }
        }
      }
      
      if (type === '2') {
        // Tab-2
        const deptSelect = document.getElementById('pSustCd2');
        const majorSelect = document.getElementById('pMajorCd2');
        if (deptSelect && majorSelect) {
          const deptValue = deptSelect.value;
          majorSelect.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue) {
            const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
            majors.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              majorSelect.appendChild(opt);
            });
          }
        }

        // Tab-1
        const deptSelect_tab1 = document.getElementById('pSustCd2-tab1');
        const majorSelect_tab1 = document.getElementById('pMajorCd2-tab1');
        if (deptSelect_tab1 && majorSelect_tab1) {
          const deptValue = deptSelect_tab1.value;
          majorSelect_tab1.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue) {
            const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
            majors.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              majorSelect_tab1.appendChild(opt);
            });
          }
        }
      }
      
      if (type === '3') {
        // Tab-2
        const deptSelect = document.getElementById('pSustCd3');
        const majorSelect = document.getElementById('pMajorCd3');
        if (deptSelect && majorSelect) {
          const deptValue = deptSelect.value;
          majorSelect.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue) {
            const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
            majors.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              majorSelect.appendChild(opt);
            });
          }
        }

        // Tab-1
        const deptSelect_tab1 = document.getElementById('pSustCd3-tab1');
        const majorSelect_tab1 = document.getElementById('pMajorCd3-tab1');
        if (deptSelect_tab1 && majorSelect_tab1) {
          const deptValue = deptSelect_tab1.value;
          majorSelect_tab1.innerHTML = '<option value="">전체학과</option>';
          
          if (deptValue) {
            const majors = [...new Set(allSubjects.filter(s => s.dept === deptValue).map(s => s.major).filter(m => m && String(m).trim()))].sort();
            majors.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m;
              majorSelect_tab1.appendChild(opt);
            });
          }
        }
      }
    }

    // 이수구분 필터링 (검색 타입 2)
    function fnComboIsuFilter(type) {
      console.log('[fnComboIsuFilter] type:', type);
      if (type === '2') {
        // Tab-2
        const isuSelect = document.getElementById('pIsuCd2');
        if (isuSelect) {
          const isuValue = isuSelect.value;
          const selectRow = document.getElementById('idThSelect2');
          const downRow = document.getElementById('idThDown2');
          
          if (isuValue === '교양선택') {
            selectRow.style.display = '';
            document.getElementById('idTdSelect2').style.display = '';
            downRow.style.display = '';
            document.getElementById('idTdDown2').style.display = '';
          } else {
            selectRow.style.display = 'none';
            document.getElementById('idTdSelect2').style.display = 'none';
            downRow.style.display = 'none';
            document.getElementById('idTdDown2').style.display = 'none';
          }
        }

        // Tab-1
        const isuSelect_tab1 = document.getElementById('pIsuCd2-tab1');
        if (isuSelect_tab1) {
          const isuValue = isuSelect_tab1.value;
          const selectRow = document.getElementById('idThSelect2-tab1');
          const downRow = document.getElementById('idThDown2-tab1');
          
          if (isuValue === '교양선택') {
            selectRow.style.display = '';
            document.getElementById('idTdSelect2-tab1').style.display = '';
            downRow.style.display = '';
            document.getElementById('idTdDown2-tab1').style.display = '';
          } else {
            selectRow.style.display = 'none';
            document.getElementById('idTdSelect2-tab1').style.display = 'none';
            downRow.style.display = 'none';
            document.getElementById('idTdDown2-tab1').style.display = 'none';
          }
        }
      }
    }

    // 이수구분 select 초기화 및 학부 초기화 (검색 타입 2)
    function initIsuTypes() {
      // Tab-2
      const select = document.getElementById('pIsuCd2');
      if (select) {
        select.innerHTML = '';
        const types = [
          { text: '전공필수' },
          { text: '전공선택' },
          { text: '전공기초' },
          { text: '교양필수' },
          { text: '교양선택' },
          { text: '채플' },
          { text: '연계필수' },
          { text: '연계선택' }
        ];
        types.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type.text;
          opt.textContent = type.text;
          select.appendChild(opt);
        });
      }
      
      // Tab-1
      const selectTab1 = document.getElementById('pIsuCd2-tab1');
      if (selectTab1) {
        selectTab1.innerHTML = '';
        const types = [
          { text: '전공필수' },
          { text: '전공선택' },
          { text: '전공기초' },
          { text: '교양필수' },
          { text: '교양선택' },
          { text: '채플' },
          { text: '연계필수' },
          { text: '연계선택' }
        ];
        types.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type.text;
          opt.textContent = type.text;
          selectTab1.appendChild(opt);
        });
      }

      // 교양선택 options (Tab-2)
      const selectCd = document.getElementById('pSelectCd2');
      if (selectCd) {
        selectCd.innerHTML = '';
        ['핵심', '자유'].forEach((text) => {
          const opt = document.createElement('option');
          opt.value = text;
          opt.textContent = text;
          selectCd.appendChild(opt);
        });
      }

      // 교양선택 options (Tab-1)
      const selectCd_tab1 = document.getElementById('pSelectCd2-tab1');
      if (selectCd_tab1) {
        selectCd_tab1.innerHTML = '';
        ['핵심', '자유'].forEach((text) => {
          const opt = document.createElement('option');
          opt.value = text;
          opt.textContent = text;
          selectCd_tab1.appendChild(opt);
        });
      }

      // 하위영역 options (Tab-2)
      const downCd = document.getElementById('pDownCd2');
      if (downCd) {
        downCd.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          downCd.appendChild(opt);
        });
      }

      // 하위영역 options (Tab-1)
      const downCd_tab1 = document.getElementById('pDownCd2-tab1');
      if (downCd_tab1) {
        downCd_tab1.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          downCd_tab1.appendChild(opt);
        });
      }

      // 영역 options (Tab-2)
      const areaCd = document.getElementById('pAreaCd2');
      if (areaCd) {
        areaCd.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' },
          { value: '융복합', text: '융복합' },
          { value: '', text: '전체' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          areaCd.appendChild(opt);
        });
      }

      // 영역 options (Tab-1)
      const areaCd_tab1 = document.getElementById('pAreaCd2-tab1');
      if (areaCd_tab1) {
        areaCd_tab1.innerHTML = '';
        const areas = [
          { value: 'C(창의성)', text: 'C(창의성)' },
          { value: 'H(나눔·배려)', text: 'H(나눔·배려)' },
          { value: 'A(비판·분석적사고)', text: 'A(비판·분석적사고)' },
          { value: 'M(소통)', text: 'M(소통)' },
          { value: 'P(문제해결)', text: 'P(문제해결)' },
          { value: '융복합', text: '융복합' },
          { value: '', text: '전체' }
        ];
        areas.forEach(area => {
          const opt = document.createElement('option');
          opt.value = area.value;
          opt.textContent = area.text;
          areaCd_tab1.appendChild(opt);
        });
      }

      // 학부 초기화 (Tab-2)
      const sustSelect = document.getElementById('pSustCd2');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          sustSelect.addEventListener('change', function() {
            fnComboMajorFilter('2');
          });
          fnComboMajorFilter('2');
        }
      }

      // 학부 초기화 (Tab-1)
      const sustSelect_tab1 = document.getElementById('pSustCd2-tab1');
      if (sustSelect_tab1) {
        sustSelect_tab1.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect_tab1.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect_tab1.value = depts[0];
          sustSelect_tab1.addEventListener('change', function() {
            fnComboMajorFilter('2');
          });
          fnComboMajorFilter('2');
        }
      }

      // 학과 초기화 (Tab-2, Tab-1)
      const majorSelect = document.getElementById('pMajorCd2');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
      }

      const majorSelect_tab1 = document.getElementById('pMajorCd2-tab1');
      if (majorSelect_tab1) {
        majorSelect_tab1.innerHTML = '<option value="">전체학과</option>';
      }
    }

    // 다전공 선택에 따라 조건부 옵션 표시/숨김 (검색 타입 3)
    function fnChkVal(type) {
      if (type === '3') {
        // Tab-2
        const multiSelect = document.getElementById('pMultiCd3');
        const multiValue = multiSelect?.value;
        const compositeRow = document.getElementById('idThComposite3');
        const microRow = document.getElementById('idThMicro3');

        if (multiValue === 'CMF005008') {
          compositeRow.style.display = '';
          document.getElementById('idTdComposite3').style.display = '';
        } else {
          compositeRow.style.display = 'none';
          document.getElementById('idTdComposite3').style.display = 'none';
        }

        if (multiValue === 'CMF005009') {
          microRow.style.display = '';
          document.getElementById('idTdMicro3').style.display = '';
        } else {
          microRow.style.display = 'none';
          document.getElementById('idTdMicro3').style.display = 'none';
        }

        // Tab-1
        const multiSelect_tab1 = document.getElementById('pMultiCd3-tab1');
        const multiValue_tab1 = multiSelect_tab1?.value;
        const compositeRow_tab1 = document.getElementById('idThComposite3-tab1');
        const microRow_tab1 = document.getElementById('idThMicro3-tab1');

        if (multiValue_tab1 === 'CMF005008') {
          compositeRow_tab1.style.display = '';
          document.getElementById('idTdComposite3-tab1').style.display = '';
        } else {
          compositeRow_tab1.style.display = 'none';
          document.getElementById('idTdComposite3-tab1').style.display = 'none';
        }

        if (multiValue_tab1 === 'CMF005009') {
          microRow_tab1.style.display = '';
          document.getElementById('idTdMicro3-tab1').style.display = '';
        } else {
          microRow_tab1.style.display = 'none';
          document.getElementById('idTdMicro3-tab1').style.display = 'none';
        }
      }
    }

    // 다전공 select 초기화 (검색 타입 3)
    function initMultipleTypes() {
      // Tab-2
      const select = document.getElementById('pMultiCd3');
      if (select) {
        select.innerHTML = '';
        const types = [
          { value: 'CMF005001', text: '부전공' },
          { value: 'CMF005002', text: '복수전공' },
          { value: 'CMF005008', text: '융복합전공' },
          { value: 'CMF005009', text: '마이크로전공' }
        ];
        
        types.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type.value;
          opt.textContent = type.text;
          select.appendChild(opt);
        });

        select.addEventListener('change', function() {
          fnComboMajorFilter('3');
          fnChkVal('3');
        });
      }

      // Tab-1
      const select_tab1 = document.getElementById('pMultiCd3-tab1');
      if (select_tab1) {
        select_tab1.innerHTML = '';
        const types = [
          { value: 'CMF005001', text: '부전공' },
          { value: 'CMF005002', text: '복수전공' },
          { value: 'CMF005008', text: '융복합전공' },
          { value: 'CMF005009', text: '마이크로전공' }
        ];
        
        types.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type.value;
          opt.textContent = type.text;
          select_tab1.appendChild(opt);
        });

        select_tab1.addEventListener('change', function() {
          fnComboMajorFilter('3');
          fnChkVal('3');
        });
      }

      // 학부 초기화 (Tab-2)
      const sustSelect = document.getElementById('pSustCd3');
      if (sustSelect) {
        sustSelect.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect.value = depts[0];
          sustSelect.addEventListener('change', function() {
            fnComboMajorFilter('3');
          });
          fnComboMajorFilter('3');
        }
      }

      // 학부 초기화 (Tab-1)
      const sustSelect_tab1 = document.getElementById('pSustCd3-tab1');
      if (sustSelect_tab1) {
        sustSelect_tab1.innerHTML = '';
        const depts = [...new Set(allSubjects.map(s => s.dept).filter(d => d && String(d).trim()))].sort();
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          sustSelect_tab1.appendChild(opt);
        });
        
        if (depts.length > 0) {
          sustSelect_tab1.value = depts[0];
          sustSelect_tab1.addEventListener('change', function() {
            fnComboMajorFilter('3');
          });
          fnComboMajorFilter('3');
        }
      }

      // 학과 초기화 (Tab-2, Tab-1)
      const majorSelect = document.getElementById('pMajorCd3');
      if (majorSelect) {
        majorSelect.innerHTML = '<option value="">전체학과</option>';
      }

      const majorSelect_tab1 = document.getElementById('pMajorCd3-tab1');
      if (majorSelect_tab1) {
        majorSelect_tab1.innerHTML = '<option value="">전체학과</option>';
      }

      // 융복합 초기화 (Tab-2)
      const complexCd = document.getElementById('pComplexCd3');
      if (complexCd) {
        complexCd.innerHTML = '';
        const complexes = [
          { value: '', text: '선택안함' },
          { value: 'U0130010000', text: '청소년전공' },
          { value: 'U0130020000', text: '글로벌외국어통상무역전공' },
          { value: 'U0130030000', text: '스포츠헬스케어전공' },
          { value: 'U0130040000', text: '멀티미디어사운드&뮤직' }
        ];
        complexes.forEach(complex => {
          const opt = document.createElement('option');
          opt.value = complex.value;
          opt.textContent = complex.text;
          complexCd.appendChild(opt);
        });
      }

      // 융복합 초기화 (Tab-1)
      const complexCd_tab1 = document.getElementById('pComplexCd3-tab1');
      if (complexCd_tab1) {
        complexCd_tab1.innerHTML = '';
        const complexes = [
          { value: '', text: '선택안함' },
          { value: 'U0130010000', text: '청소년전공' },
          { value: 'U0130020000', text: '글로벌외국어통상무역전공' },
          { value: 'U0130030000', text: '스포츠헬스케어전공' },
          { value: 'U0130040000', text: '멀티미디어사운드&뮤직' }
        ];
        complexes.forEach(complex => {
          const opt = document.createElement('option');
          opt.value = complex.value;
          opt.textContent = complex.text;
          complexCd_tab1.appendChild(opt);
        });
      }

      // 마이크로전공 초기화 (Tab-2)
      const microCd = document.getElementById('pMicroCd3');
      if (microCd) {
        microCd.innerHTML = '';
        const micros = [
          { value: '', text: '선택안함' },
          { value: 'CMI012001', text: '디지털마케팅전문가과정' },
          { value: 'CMI012002', text: '창의융합예술교육전문학위과정' },
          { value: 'CMI012003', text: 'HSK교육전문가과정' }
        ];
        micros.forEach(micro => {
          const opt = document.createElement('option');
          opt.value = micro.value;
          opt.textContent = micro.text;
          microCd.appendChild(opt);
        });
      }

      // 마이크로전공 초기화 (Tab-1)
      const microCd_tab1 = document.getElementById('pMicroCd3-tab1');
      if (microCd_tab1) {
        microCd_tab1.innerHTML = '';
        const micros = [
          { value: '', text: '선택안함' },
          { value: 'CMI012001', text: '디지털마케팅전문가과정' },
          { value: 'CMI012002', text: '창의융합예술교육전문학위과정' },
          { value: 'CMI012003', text: 'HSK교육전문가과정' }
        ];
        micros.forEach(micro => {
          const opt = document.createElement('option');
          opt.value = micro.value;
          opt.textContent = micro.text;
          microCd_tab1.appendChild(opt);
        });
      }
    }

    // 과목 필터링 (검색 타입별로 다른 필터 적용)
    function filterCourses(searchType = null, tab = 'tab2') {
      if (searchType === null) searchType = currentSearchType;
      console.log('[filterCourses] searchType:', searchType, 'tab:', tab, 'allSubjects:', allSubjects.length);

      const prefix = tab === 'tab1' ? '-tab1' : '';
      let filtered = [];

      // Tab-1은 항상 basketList만 필터링
      if (tab === 'tab1') {
        const basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
        const major = document.getElementById('pMajorCd1-tab1')?.value || '';
        const search = (document.getElementById('pLectNm1-tab1')?.value || '').toLowerCase();

        console.log('[filterCourses-tab1] basketList count:', basketList.length, 'major:', major, 'search:', search);

        filtered = basketList.filter(s => {
          if (major && s.major !== major) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
        console.log('[filterCourses-tab1] filtered count:', filtered.length);
      } else if (searchType === '1') {
        // Tab-2: 학부/학과 검색
        const dept = document.getElementById(`pSustCd1${prefix}`)?.value || '';
        const major = document.getElementById(`pMajorCd1${prefix}`)?.value || '';
        const search = (document.getElementById(`pLectNm1${prefix}`)?.value || '').toLowerCase();

        console.log('[filterCourses-1] dept:', dept, 'major:', major, 'search:', search);

        if (dept === 'basket') {
          const basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
          filtered = basketList.filter(s => {
            if (major && s.major !== major) return false;
            if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
            return true;
          });
        } else if (dept) {
          filtered = allSubjects.filter(s => {
            if (s.dept !== dept) return false;
            if (major && s.major !== major) return false;
            if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
            return true;
          });
        }
      } else if (searchType === '2') {
        // Tab-2: 이수구분 검색
        const type = document.getElementById(`pIsuCd2${prefix}`)?.value || '';
        const sustValue = document.getElementById(`pSustCd2${prefix}`)?.value || '';
        const majorValue = document.getElementById(`pMajorCd2${prefix}`)?.value || '';
        const search = (document.getElementById(`pLectNm2${prefix}`)?.value || '').toLowerCase();

        console.log('[filterCourses-2] type:', type, 'sustValue:', sustValue, 'majorValue:', majorValue, 'search:', search);

        filtered = allSubjects.filter(s => {
          if (type && s.type !== type) {
            console.log('[type check failed] expected:', type, 'got:', s.type, 'course:', s.name);
            return false;
          }
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
        console.log('[filterCourses-2] filtered count:', filtered.length);
      } else if (searchType === '3') {
        // 다전공 검색
        const multiValue = document.getElementById(`pMultiCd3${prefix}`)?.value || '';
        const sustValue = document.getElementById(`pSustCd3${prefix}`)?.value || '';
        const majorValue = document.getElementById(`pMajorCd3${prefix}`)?.value || '';
        const search = (document.getElementById(`pLectNm3${prefix}`)?.value || '').toLowerCase();

        console.log('[filterCourses-3] multiValue:', multiValue, 'sustValue:', sustValue, 'majorValue:', majorValue, 'search:', search);

        filtered = allSubjects.filter(s => {
          if (sustValue && s.dept !== sustValue) return false;
          if (majorValue && s.major !== majorValue) return false;
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
        console.log('[filterCourses-3] filtered count:', filtered.length);
      } else if (searchType === '0') {
        // 과목 직접 검색
        const search = (document.getElementById(`pLectNm0${prefix}`)?.value || '').toLowerCase();
        filtered = allSubjects.filter(s => {
          if (search && !s.name.toLowerCase().includes(search) && !s.code.includes(search)) return false;
          return true;
        });
      }

      const totalCountId = tab === 'tab1' ? 'total-count-tab1' : 'total-count';
      const courseTableId = tab === 'tab1' ? 'course-table-tab1' : 'course-table';

      document.getElementById(totalCountId).textContent = filtered.length;
      const tbody = document.getElementById(courseTableId);
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">검색 결과가 없습니다.</td></tr>';
        return;
      }

      filtered.forEach((s, i) => {
        const defaultCap = s.cap !== undefined ? parseInt(s.cap) : 30;
        const capacityMap = JSON.parse(localStorage.getItem('courseCapacity') || '{}');
        const cap = typeof capacityMap[s.code] !== 'undefined' ? parseInt(capacityMap[s.code]) : defaultCap;
        const isAdded = JSON.parse(localStorage.getItem('registerList') || '[]').some(r => r.code === s.code);

        const tr = document.createElement('tr');
        let cellHtml = '';
        
        // 정원 체크 로직
        const disabledBtn = `<button class="btn-add" disabled="disabled" style="opacity:0.5; cursor:not-allowed;">마감</button>`;
        const appliedSpan = `<span style="color:#d32f2f;">신청</span>`;
        const canApply = cap > 0 && !isAdded;
        
        if (tab === 'tab1') {
          // Tab-1: 이미 신청한 과목만 표시
          const btnHtml = isAdded ? appliedSpan : (canApply ? `<button class="btn-add" onclick="addToRegister('${s.code}', '${s.name}', '${s.dept}', '${s.major}', '${s.year}', '${s.type}', '${s.credit}', '${defaultCap}', '${tab}')">신청</button>` : disabledBtn);
          cellHtml = `<td>${btnHtml}</td>`;
        } else {
          // Tab-2: 신청 상태에 따른 버튼 표시
          const btnHtml = isAdded ? appliedSpan : (canApply ? `<button class="btn-add" onclick="addToRegister('${s.code}', '${s.name}', '${s.dept}', '${s.major}', '${s.year}', '${s.type}', '${s.credit}', '${defaultCap}', '${tab}')">신청</button>` : disabledBtn);
          cellHtml = `<td>${btnHtml}</td>`;
        }
        
        tr.innerHTML = cellHtml + `
          <td>${s.dept}</td>
          <td>${s.major}</td>
          <td>${s.year}</td>
          <td>${s.name}</td>
          <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
          <td>${s.type}</td>
          <td>${s.credit}</td>
          <td>0</td>
          <td>${cap}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 수강신청 추가 (정원 감소 포함)
    function addToRegister(code, name, dept, major, year, type, credit, cap, tab = 'tab2') {
      // 타이머 시간 체크 - 타이머가 설정되지 않으면 신청 불가
      if (!window.timerOpenTime) {
        QueueModal.showTimeNotYet();
        return;
      }

      const now = new Date();
      if (now < window.timerOpenTime) {
        // 아직 시간이 되지 않았으면 모달 표시 후 종료
        QueueModal.showTimeNotYet();
        return;
      }

      // 시간이 되었으면 정상적으로 신청 진행
      QueueModal.showApply(function() {
        if (!dept || !dept.trim() || !major || !major.trim()) {
          alert('유효한 과목이 아닙니다.');
          return;
        }

        let list = JSON.parse(localStorage.getItem('registerList') || '[]');
        if (list.find(s => s.code === code)) {
          alert('이미 신청한 과목입니다.');
          return;
        }

        // 정원 정보 가져오기 (localStorage에 저장된 정원 상태)
        let capacityMap = JSON.parse(localStorage.getItem('courseCapacity') || '{}');
        const currentCap = parseInt(capacityMap[code]) || parseInt(cap);

        // 정원이 0이면 신청 불가
        if (currentCap <= 0) {
          alert('정원이 마감되었습니다.');
          return;
        }

        // 정원 감소
        capacityMap[code] = currentCap - 1;
        localStorage.setItem('courseCapacity', JSON.stringify(capacityMap));

        list.push({ code, name, dept, major, year, type, credit, cap: currentCap - 1 });
        localStorage.setItem('registerList', JSON.stringify(list));
        filterCourses(currentSearchType, tab);
        renderRegisterList(tab);
        
        alert(`신청되었습니다. (남은 정원: ${currentCap - 1}명)`);
      });
    }

    // 예비수강 추가 (Tab-1용)
    function addToBasket(code, name, dept, major, year, type, credit, cap) {
      let list = JSON.parse(localStorage.getItem('basketList') || '[]');
      if (list.find(s => s.code === code)) {
        alert('이미 예비수강한 과목입니다.');
        return;
      }
      list.push({ code, name, dept, major, year, type, credit, cap });
      localStorage.setItem('basketList', JSON.stringify(list));
      filterCourses(currentSearchType, 'tab1');
    }

    // 수강신청 삭제 (정원 복구)
    function removeFromRegister(code, tab = 'tab2') {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      const removed = list.find(s => s.code === code);
      
      if (removed) {
        // 정원 복구
        let capacityMap = JSON.parse(localStorage.getItem('courseCapacity') || '{}');
        capacityMap[code] = (parseInt(capacityMap[code]) || 0) + 1;
        localStorage.setItem('courseCapacity', JSON.stringify(capacityMap));
      }

      list = list.filter(s => s.code !== code);
      localStorage.setItem('registerList', JSON.stringify(list));
      filterCourses(currentSearchType, tab);
      renderRegisterList(tab);
    }

    // 수강신청 목록 렌더링
    function renderRegisterList(tab = null) {
      let list = JSON.parse(localStorage.getItem('registerList') || '[]');
      
      const tabs = tab ? [tab] : ['tab1', 'tab2'];
      tabs.forEach(t => {
        const tableId = t === 'tab1' ? 'register-table-tab1' : 'register-table';
        const creditId = t === 'tab1' ? 'register-credit-tab1' : 'register-credit';
        const countId = t === 'tab1' ? 'register-count-tab1' : 'register-count';
        
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = '';

        if (list.length === 0) {
          document.getElementById(creditId).textContent = '0';
          document.getElementById(countId).textContent = '0';
          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#999;">신청이 없습니다.</td></tr>';
          return;
        }

        let totalCredit = 0;
        list.forEach((s, i) => {
          totalCredit += parseInt(s.credit, 10);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><button class="btn-del" onclick="removeFromRegister('${s.code}', '${t}')">삭제</button></td>
            <td>${s.dept}</td>
            <td>${s.major}</td>
            <td>${s.year}</td>
            <td>${s.name}</td>
            <td><a href="javascript:void(0);" style="color:#1976d2; text-decoration:none;">${s.code}</a></td>
            <td>${s.type}</td>
            <td>${s.credit}</td>
            <td>0</td>
            <td>${s.cap}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById(creditId).textContent = totalCredit;
        document.getElementById(countId).textContent = list.length;
      });
    }

    // 빠른수강신청 함수
    function quickAddToRegister() {
      const code = document.getElementById('quick-code').value.trim();
      const classNum = document.getElementById('quick-class').value.trim();

      if (!code) {
        alert('과목코드를 입력해주세요.');
        return;
      }

      const subject = allSubjects.find(s => s.code === code);
      if (!subject) {
        alert('해당 과목을 찾을 수 없습니다.');
        return;
      }

      let registerList = JSON.parse(localStorage.getItem('registerList') || '[]');
      if (registerList.find(s => s.code === code)) {
        alert('이미 수강신청에 있습니다.');
        return;
      }

      QueueModal.showApply(function() {
        registerList.push(subject);
        localStorage.setItem('registerList', JSON.stringify(registerList));

        alert('수강신청에 추가되었습니다.');
        document.getElementById('quick-code').value = '';
        document.getElementById('quick-class').value = '';
        document.getElementById('quick-code').focus();

        renderRegisterList();
      });
    }

    // 초기화
    function initializeApp() {
      console.log('initializeApp called, allSubjects.length:', allSubjects.length);
      
      // 1학년 1학기 체크 - Tab-1 숨김/표시
      const userGrade = localStorage.getItem('userGrade') || '2';
      const tab1Menu = document.getElementById('tab-1-menu');
      const tab1Content = document.getElementById('tab-1');
      
      if (userGrade === '1') {
        // 1학년 1학기: Tab-1 숨김 및 Tab-2를 기본으로 활성화
        tab1Menu.style.display = 'none';
        tab1Content.classList.remove('is-active');
        
        // Tab-2를 활성화
        const tab2Menu = document.querySelector('[data-tab="tab-2"]');
        const tab2Content = document.getElementById('tab-2');
        tab2Menu.classList.add('is-active');
        tab2Content.classList.add('is-active');
        
        console.log('[initializeApp] Tab-1 hidden for grade 1, Tab-2 activated');
      } else {
        // 2학년 이상: Tab-1 표시 및 활성화
        tab1Menu.style.display = '';
        tab1Content.classList.add('is-active');
        
        // Tab-2 비활성화
        const tab2Menu = document.querySelector('[data-tab="tab-2"]');
        const tab2Content = document.getElementById('tab-2');
        tab2Menu.classList.remove('is-active');
        tab2Content.classList.remove('is-active');
        
        console.log('[initializeApp] Tab-1 shown for grade', userGrade);
      }
      
      // 라디오 버튼 이벤트 리스너 추가
      initRadioFormSwitch();
      
      // 각 검색 타입별 select 초기화
      console.log('[initializeApp] initDepts1 시작');
      initDepts1();
      console.log('[initializeApp] initDepts1 완료');
      
      console.log('[initializeApp] initIsuTypes 시작');
      initIsuTypes();
      console.log('[initializeApp] initIsuTypes 완료');
      
      console.log('[initializeApp] initMultipleTypes 시작');
      initMultipleTypes();
      console.log('[initializeApp] initMultipleTypes 완료');

      // 초기 필터링
      try {
        // Tab-1 필터링
        filterCourses('1', 'tab1');
        console.log('[initializeApp] default filter applied (Tab-1)');
        
        // Tab-2 필터링
        filterCourses('1', 'tab2');
        console.log('[initializeApp] default filter applied (Tab-2)');
      } catch (e) {
        console.warn('[initializeApp] filter failed', e);
      }

      // 신청 내역 렌더링
      renderRegisterList();
    }
    
    // DOM 로드 후 초기화
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        initializeApp();
      });
    } else {
      console.log('DOM already loaded, initializing now');
      initializeApp();
    }

    // ==================== 자동 정원 감소 시뮬레이션 (2~3초, 3~5개) ====================
    let advancedTrafficActive = false;
    let advancedTrafficInterval = null;

    function startAdvancedTrafficSimulation() {
      if (advancedTrafficActive) return;
      advancedTrafficActive = true;
      
      // 초기 1회 실행
      performAdvancedTraffic();
      
      // 2~3초마다 반복 (2000~3000ms 범위의 랜덤)
      const scheduleNext = function() {
        const delay = Math.floor(Math.random() * 1000) + 2000; // 2000~3000ms
        advancedTrafficInterval = setTimeout(function() {
          if (advancedTrafficActive) {
            performAdvancedTraffic();
            scheduleNext(); // 다음 실행 예약
          }
        }, delay);
      };
      
      scheduleNext();
    }

    function stopAdvancedTrafficSimulation() {
      advancedTrafficActive = false;
      if (advancedTrafficInterval !== null) {
        clearTimeout(advancedTrafficInterval);
        advancedTrafficInterval = null;
      }
    }

    function performAdvancedTraffic() {
      if (!advancedTrafficActive) return;

      try {
        // 모든 과목 중에서 무작위로 20개 선택
        const coursesToUpdate = [];
        const availableCourses = [...allSubjects];
        
        for (let i = 0; i < Math.min(20, availableCourses.length); i++) {
          const randomIndex = Math.floor(Math.random() * availableCourses.length);
          coursesToUpdate.push(availableCourses[randomIndex]);
          availableCourses.splice(randomIndex, 1);
        }

        // courseCapacity 가져오기
        let capacityMap = JSON.parse(localStorage.getItem('courseCapacity') || '{}');

        // 선택된 과목들의 정원 감소 (3-5개)
        coursesToUpdate.forEach(course => {
          const defaultCap = parseInt(course.cap) || 30;
          const currentCap = typeof capacityMap[course.code] !== 'undefined' ? parseInt(capacityMap[course.code]) : defaultCap;
          const decreaseAmount = Math.floor(Math.random() * 3) + 3; // 3~5 사이의 랜덤 값
          const newCap = Math.max(0, currentCap - decreaseAmount);
          capacityMap[course.code] = newCap;
        });

        // localStorage에 저장
        localStorage.setItem('courseCapacity', JSON.stringify(capacityMap));

        // UI 업데이트 (현재 표시된 탭만 갱신)
        const activeTab = document.querySelector('.sw-tabs li.is-active')?.dataset.tab || 'tab-2';
        filterCourses('1', activeTab);
        
        console.log('[AdvancedTraffic] Updated', coursesToUpdate.length, 'courses');
      } catch (e) {
        console.error('[AdvancedTraffic] Error:', e);
      }
    }

    // 초기화: localStorage에서 설정 읽기
    const autoTraffic = localStorage.getItem('autoTrafficSimulation') === 'true';
    if (autoTraffic) {
      advancedTrafficActive = true;
      startAdvancedTrafficSimulation();
    }

    // ==================== 타이머 기반 자동 신청 ====================
    let timerBasedInterval = null;
    let timerRegistered = false;

    // index.html에서 타이머 설정 후 호출됨
    window.initTimerBasedRegistration = function(openTime) {
      console.log('[initTimerBasedRegistration] openTime:', openTime);
      window.timerOpenTime = openTime;
      timerRegistered = true;
      
      // 기존 interval 정리
      if (timerBasedInterval) clearInterval(timerBasedInterval);
      
      // 1초마다 확인
      timerBasedInterval = setInterval(function() {
        const now = new Date();
        if (now >= window.timerOpenTime) {
          console.log('[TimerBased] 신청 시간 도래! 자동 신청 시작');
          registerOnTimer();
          clearInterval(timerBasedInterval);
          timerBasedInterval = null;
        }
      }, 1000);
    };

    // 타이머 시간 도래 시 basketList 모든 과목 신청 버튼 자동 클릭
    function registerOnTimer() {
      const basketList = JSON.parse(localStorage.getItem('basketList') || '[]');
      const registerList = JSON.parse(localStorage.getItem('registerList') || '[]');

      console.log('[registerOnTimer] basketList:', basketList.length, '개 과목 자동 신청 시작');

      basketList.forEach((course, index) => {
        // 이미 신청된 과목은 스킵
        if (registerList.find(s => s.code === course.code)) {
          console.log('[registerOnTimer] 이미 신청됨:', course.name);
          return;
        }

        // 정원 체크
        let capacityMap = JSON.parse(localStorage.getItem('courseCapacity') || '{}');
        const defaultCap = parseInt(course.cap) || 30;
        const currentCap = typeof capacityMap[course.code] !== 'undefined' ? parseInt(capacityMap[course.code]) : defaultCap;

        if (currentCap <= 0) {
          console.log('[registerOnTimer] 정원이 마감됨:', course.name);
          return;
        }

        // addToRegister 호출 - 신청 버튼 클릭과 동일하게 동작
        try {
          // 신청 처리 (QueueModal 없이 직접 처리)
          let list = JSON.parse(localStorage.getItem('registerList') || '[]');
          capacityMap[course.code] = currentCap - 1;
          localStorage.setItem('courseCapacity', JSON.stringify(capacityMap));
          
          list.push({ 
            code: course.code, 
            name: course.name, 
            dept: course.dept, 
            major: course.major, 
            year: course.year, 
            type: course.type, 
            credit: course.credit, 
            cap: currentCap - 1 
          });
          
          localStorage.setItem('registerList', JSON.stringify(list));
          console.log('[registerOnTimer] ✓ 신청 완료:', course.name, '(남은 정원:', (currentCap - 1), '명)');
        } catch (e) {
          console.error('[registerOnTimer] 신청 실패:', course.name, e);
        }
      });

      // UI 업데이트
      filterCourses('1', 'tab1');
      renderRegisterList();
    }
  </script>
</body>
</html>
